generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum MeasureUnit {
  UNID
  KG
  L
}

enum PriceLogic {
  SUM
  MAX
}

enum DeliveryType {
  RETIRO
  ENVIO
}

enum PaymentMethod {
  EFECTIVO
  MERCADO_PAGO
  TRANSFERENCIA
  TARJETA_CREDITO
  TARJETA_DEBITO
}

enum OrderStatus {
  PENDIENTE
  PAGADO
  EN_PREPARACION
  ENTREGADO
  CANCELADO
}

model Provider {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  products    Product[]
  ingredients Ingredient[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String
  parentId  Int?
  parent    Category?  @relation("CategoryToSelf", fields: [parentId], references: [id], onDelete: Cascade)
  children  Category[] @relation("CategoryToSelf")

  productsLevel1 Product[] @relation("CategoryLevel1")
  productsLevel2 Product[] @relation("CategoryLevel2")

  @@unique([parentId, name])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id             Int      @id @default(autoincrement())
  externalSource String   @default("fudo")
  externalId     BigInt
  code           String?
  name           String
  description    String?
  price          Decimal  @db.Decimal(14, 2)
  cost           Decimal? @db.Decimal(14, 2)
  isActive       Boolean  @default(true)
  isFavorite     Boolean  @default(false)
  trackStock     Boolean  @default(false)
  sellableAlone  Boolean  @default(true)
  sortWeight     Int?

  providerId Int?
  provider   Provider? @relation(fields: [providerId], references: [id])

  categoryId    Int?
  category      Category? @relation("CategoryLevel1", fields: [categoryId], references: [id])
  subcategoryId Int?
  subcategory   Category? @relation("CategoryLevel2", fields: [subcategoryId], references: [id])

  modifierItems  ModifierGroupItem[]
  modifierGroups ProductModifierGroup[]

  bom        ProductIngredient[]
  image      ProductImage?
  orderItems OrderItem[]

  @@unique([externalSource, externalId])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Ingredient {
  id             Int         @id @default(autoincrement())
  externalSource String      @default("fudo")
  externalId     BigInt
  name           String
  unit           MeasureUnit
  trackStock     Boolean     @default(false)
  providerId     Int?
  provider       Provider?   @relation(fields: [providerId], references: [id])

  products ProductIngredient[]

  @@unique([externalSource, externalId])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductIngredient {
  productId    Int
  ingredientId Int
  qty          Decimal @db.Decimal(12, 4)

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@id([productId, ingredientId])
}

model ModifierGroup {
  id         Int        @id @default(autoincrement())
  name       String     @unique
  publicName String?
  logic      PriceLogic
  minQty     Int?
  maxQty     Int?

  items    ModifierGroupItem[]
  products ProductModifierGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ModifierGroupItem {
  groupId    Int
  productId  Int
  price      Decimal @db.Decimal(14, 2)
  perItemMax Int?

  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([groupId, productId])
}

model ProductModifierGroup {
  productId Int
  groupId   Int

  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([productId, groupId])
}

model ProductImage {
  id          Int     @id @default(autoincrement())
  productId   Int     @unique
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  imageUrl    String
  imagePath   String?
  category    String?
  subcategory String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id        Int      @id @default(autoincrement())
  fullName  String
  email     String?  @unique
  phone     String?
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([phone])
}

model Zone {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  polygon     Json     // [[lat,lng], ...]
  deliveryFee Int
  active      Boolean  @default(true)
  priority    Int      @default(0)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@index([active])
  @@index([priority])
}

model Order {
  id            Int           @id @default(autoincrement())
  userId        Int?
  user          User?         @relation(fields: [userId], references: [id])
  deliveryType  DeliveryType
  address       Json?
  comments      String?
  paymentMethod PaymentMethod
  status        OrderStatus   @default(PENDIENTE)
  totalAmount   Decimal       @default(0) @db.Decimal(14, 2)
  shippingFee   Int           @default(0)
  zoneId        Int?
  zone          Zone?         @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  lat           Float?
  lng           Float?
  items         OrderItem[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([zoneId])
}

model OrderItem {
  id         Int     @id @default(autoincrement())
  orderId    Int
  productId  Int?
  product    Product? @relation(fields: [productId], references: [id])
  name       String
  quantity   Int
  unitPrice  Decimal @db.Decimal(14, 2)
  totalPrice Decimal @db.Decimal(14, 2)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@index([name])
}
